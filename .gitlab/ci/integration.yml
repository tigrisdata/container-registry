.middleware:storage: &middleware-storage
  extends: .go-version-matrix
  stage: integration

middleware:storage-googlecdn:
  <<: *middleware-storage
  variables:
    REGISTRY_STORAGE_GCS_BUCKET: $CDN_GCS_BUCKET
    REGISTRY_MIDDLEWARE_STORAGE_GOOGLECDN_BASEURL: $CDN_BASEURL
    REGISTRY_MIDDLEWARE_STORAGE_GOOGLECDN_KEYNAME: $CDN_KEYNAME
    PACKAGE: github.com/docker/distribution/registry/storage/driver/middleware/googlecdn
  before_script:
    - export GOOGLE_APPLICATION_CREDENTIALS="$CDN_CREDENTIALS"
    - export REGISTRY_MIDDLEWARE_STORAGE_GOOGLECDN_PRIVATEKEY="$CDN_PRIVATEKEY"
  script:
    - $GO_TEST -v -coverprofile=coverage.out -tags=integration

.storage-driver-test: &storage-driver-test
  extends: .go-version-matrix
  stage: integration
  variables: &storage-driver-variables
    TEST_TIMEOUT: "30m"
  script: $GO_TEST -timeout=$TEST_TIMEOUT -v -coverprofile=coverage.out -tags=$BUILDTAGS $PACKAGE

filesystem:
  <<: *storage-driver-test
  variables:
    <<: *storage-driver-variables
    PACKAGE: 'github.com/docker/distribution/registry/storage/driver/filesystem'
    TMPDIR: /mnt/tmpfs
  tags:
    # NOTE(prozlach): run on gitlab private runners where we can mount tmpfs.
    - gitlab-org-docker
  script:
    - mkdir -p /mnt/tmpfs
    - mount -t tmpfs -o size=3G tmpfs /mnt/tmpfs
    - df -h
    - $GO_TEST -timeout=$TEST_TIMEOUT -v -coverprofile=coverage.out -tags=$BUILDTAGS $PACKAGE

inmemory:
  <<: *storage-driver-test
  variables:
    <<: *storage-driver-variables
    PACKAGE: 'github.com/docker/distribution/registry/storage/driver/inmemory'
    # Always run short tests for in-memory driver or we might run out of memory
    # and cause a flaky test https://gitlab.com/gitlab-org/container-registry/-/issues/1177
  script: $GO_TEST -timeout=$TEST_TIMEOUT -v -coverprofile=coverage.out -tags=$BUILDTAGS $PACKAGE -test.short

s3:minio:
  <<: *storage-driver-test
  parallel:
    matrix:
      # Regular combinations
      - GO_VERSION: [ "1.23", "1.24" ]
        S3_DRIVER_VERSION: [ "s3", "s3_v2" ]
  rules:
    - if: $CI_COMMIT_REF_NAME != $CI_DEFAULT_BRANCH
      when: on_success
  variables:
    <<: *storage-driver-variables
    MINIO_ACCESS_KEY: "AKIAIOSFODNN7EXAMPLE"
    MINIO_SECRET_KEY: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
    REGION_ENDPOINT: "http://minio:9000"
    PACKAGE: "github.com/docker/distribution/registry/storage/driver/s3-aws"
    # NOTE(prozlach): see docs/storage-drivers/s3_v2.md#minio for explanation why:
    S3_CHECKSUM_DISABLED: "true"
  services:
    - name: minio/minio:latest
      alias: "minio"
      command: ["server", "/data"]
  before_script:
    # Download the minio client
    - wget --no-verbose https://dl.min.io/client/mc/release/linux-amd64/mc
    - chmod u+x ./mc
    # Configure the minio client to use the local minio service rather than play.minio.io
    - |
      for i in `env | grep -E 'S3|AWS' | cut -d\= -f1`; do unset $i; done;
      export S3_BUCKET="test-bucket"

      ./mc alias set s3v4 $REGION_ENDPOINT $MINIO_ACCESS_KEY $MINIO_SECRET_KEY --api=S3v4
      ./mc mb s3v4/$S3_BUCKET
  script:
    # NOTE(prozlach): Project and group credentials take precedence over job
    # credentials as per https://docs.gitlab.com/ci/variables/#cicd-variable-precedence
    # so we need clean up any env vars and set our own before we run the tests.
    - |
      for i in `env | grep -E 'S3|AWS' | cut -d\= -f1`; do unset $i; done;
      export AWS_ACCESS_KEY=$MINIO_ACCESS_KEY
      export AWS_SECRET_KEY=$MINIO_SECRET_KEY
      export AWS_REGION="us-east-2"
      export S3_BUCKET="test-bucket"
      export S3_ENCRYPT="false"
      $GO_TEST -timeout=$TEST_TIMEOUT -v -coverprofile=coverage.out -tags=$BUILDTAGS $PACKAGE

# NOTE(prozlach): S3 bucket used in tests has an auto-cleanup policy set
# - all blobs older than 24h will be deleted, so even if CI task fails, there
# is no risk that we will keep being billed for the storage indefinatelly.
# NOTE(prozlach): Instructions on how to set-up custom runner are in file
# `docs/custom_runners.md`
s3:aws:
  <<: *storage-driver-test
  parallel:
    matrix:
      # Regular combinations
      - GO_VERSION: [ "1.23", "1.24" ]
        S3_DRIVER_VERSION: [ "s3", "s3_v2" ]
        S3_AUTH_MODE: ["key_auth"]
      - GO_VERSION: [ "1.23", "1.24" ]
        S3_DRIVER_VERSION: [ "s3_v2" ]
        S3_AUTH_MODE: ["instance_auth"]
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      when: on_success
  variables:
    <<: *storage-driver-variables
    PACKAGE: "github.com/docker/distribution/registry/storage/driver/s3-aws"
  tags:
    # NOTE(prozlach): run on a custom runner, that runs on an AWS VM which has
    # managed credentials set up for the bucket that CI variables point to.
    # Other variants run here as well in order to save $$ on bandwith costs.
    - s3-managed_identity_auth
  script:
    # NOTE(prozlach): In case when we test managed credentials variant, we need
    # to make sure that AWS SDK will not try to auth with creds from
    # environment and instead tries to obtain managed credentials from the VM
    # itself.
    - |
      if [[ "$S3_AUTH_MODE" == "instance_auth" ]]; then
        echo "Unsetting key credentials"
        unset AWS_ACCESS_KEY
        unset AWS_SECRET_KEY
        unset AWS_ACCESS_KEY_ID
        unset AWS_SECRET_ACCESS_KEY
      fi
      $GO_TEST -timeout=$TEST_TIMEOUT -v -coverprofile=coverage.out -tags=$BUILDTAGS $PACKAGE

.if-fork-merge-request: &if-fork-merge-request
  if: '($CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_EVENT_TYPE != "merge_train") && $CI_PROJECT_NAMESPACE !~ /^gitlab(-org)?($|\/)/'

gcs:key_creds:
  <<: *storage-driver-test
  parallel:
    matrix:
      - GO_VERSION: [ "1.23", "1.24" ]
  rules:
    - <<: *if-fork-merge-request
      when: never
    - changes:
        - registry/storage/driver/gcs/*
        - registry/storage/driver/gcs/testdata/*
        - registry/storage/driver/testsuites/*
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  variables:
    <<: *storage-driver-variables
    REGISTRY_STORAGE_GCS_BUCKET: $GCS_BUCKET
    PACKAGE: "github.com/docker/distribution/registry/storage/driver/gcs"
    TEST_TIMEOUT: "35m"
  before_script:
    - export GOOGLE_APPLICATION_CREDENTIALS="$CDN_CREDENTIALS"

gcs:instance_creds:
  <<: *storage-driver-test
  parallel:
    matrix:
      - GO_VERSION: [ "1.23", "1.24" ]
 # Do not run in forked projects, as we are running on custom runner with
 # instance-level credentials
  rules:
    - <<: *if-fork-merge-request
      when: never
    - changes:
        - registry/storage/driver/gcs/*
        - registry/storage/driver/gcs/testdata/*
        - registry/storage/driver/testsuites/*
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  tags:
    # NOTE(prozlach): run on a custom runner, that runs on an GCS VM which has
    # managed credentials set up for the bucket that CI variables point to.
    # Other variants do not need to run here as our default runners run in
    # Google Cloud anyway.
    - gcs-managed_identity_auth
  variables:
    <<: *storage-driver-variables
    REGISTRY_STORAGE_GCS_BUCKET: $GCS_BUCKET
    PACKAGE: "github.com/docker/distribution/registry/storage/driver/gcs"
    TEST_TIMEOUT: "35m"

# NOTE(prozlach): Azure storage container used in tests has an auto-cleanup policy set
# - all blobs older than 24h will be deleted, so even if CI task fails, there
# is no risk that we will keep being billed for the storage indefinatelly.
# NOTE(prozlach): Instructions on how to set-up custom runner are in file
# `docs/custom_runners.md`
azure:
  <<: *storage-driver-test
  parallel:
    matrix:
      # Regular combinations
      - GO_VERSION: [ "1.23", "1.24" ]
        AZURE_DRIVER_VERSION: [ "azure", "azure_v2" ]
        AZURE_CREDENTIALS_TYPE: [ "shared_key" ]
      - GO_VERSION: [ "1.23", "1.24" ]
        AZURE_DRIVER_VERSION: [ "azure_v2" ]
        AZURE_CREDENTIALS_TYPE: [ "client_secret", "default_credentials" ]
 # Do not run in forked projects, as we are running on custom runner with
 # instance-level credentials
  rules:
    - <<: *if-fork-merge-request
      when: never
    # Cover the case when there is an MR merged to the default branch:
    # https://docs.gitlab.com/ci/yaml/#ruleschanges
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH && $AZURE_DRIVER_VERSION == "azure_v2"
      allow_failure: false
    # ci-tool-allowfail azure:\s\[(.*[ ,]azure[ ,].*|azure[ ,].*|.*[ ,]azure)\]
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH && $AZURE_DRIVER_VERSION == "azure"
      allow_failure: true
    - if: $AZURE_DRIVER_VERSION == "azure_v2"
      changes:
        - registry/storage/driver/azure/*
        - registry/storage/driver/azure/common/*
        - registry/storage/driver/azure/v2/*
        - registry/storage/driver/testsuites/*
      allow_failure: false
    - if: $AZURE_DRIVER_VERSION == "azure"
      changes:
        - registry/storage/driver/azure/*
        - registry/storage/driver/azure/common/*
        - registry/storage/driver/azure/v1/*
        - registry/storage/driver/testsuites/*
      allow_failure: true
  variables:
    <<: *storage-driver-variables
    PACKAGE: "github.com/docker/distribution/registry/storage/driver/azure/..."
    AZURE_DRIVER_VERSION: $AZURE_DRIVER_VERSION
    AZURE_CREDENTIALS_TYPE: $AZURE_CREDENTIALS_TYPE
    # NOTE(prozlach): Code supports `AZURE_DEBUGLOG` environment variable which
    # can be toggled in the CI via CI enviroment variables for debugging
    # if/when needed. It is currently set to `false`, set it to `true` to
    # enable debug logging.
  tags:
    # NOTE(prozlach): run on a custom runner, that runs on Azure VM which has
    # managed credentials set up for the storage account and container that CI
    # variables define. Other variants run here as well in order to save $$ on
    # bandwith costs.
    - azure-managed_identity_auth
  script:
    # NOTE(prozlach): In case when we test managed credentials variant, we need
    # to make sure that Azure SDK will not try to auth with creds from
    # environment and instead tries to obtain managed credentials from the VM
    # itself.
    - |
      if [[ "$AZURE_CREDENTIALS_TYPE" == "default_credentials" ]]; then
        echo "Unsetting key credentials"
        unset AZURE_ACCOUNT_KEY
        unset AZURE_TENANT_ID
        unset AZURE_CLIENT_ID
        unset AZURE_CLIENT_SECRET
      fi
      $GO_TEST -timeout=$TEST_TIMEOUT -v -coverprofile=coverage.out -tags=$BUILDTAGS $PACKAGE

api:
  extends: .go-version-matrix
  stage: integration
  variables:
    TAGS: 'integration,handlers_test'
    PACKAGE: 'github.com/docker/distribution/registry/handlers'
  script: $GO_TEST -v -coverprofile=coverage.out -tags=$TAGS

api:conformance:
  extends: .go-version-matrix
  stage: integration
  variables:
    TAGS: 'integration,api_conformance_test'
    PACKAGE: 'github.com/docker/distribution/registry/handlers'
  script: $GO_TEST -v -coverprofile=coverage.out -tags=$TAGS

.database: &database
  extends:
    - .go-test
    - .go-pg-version-matrix
  stage: integration
  variables: &database-variables
    FF_NETWORK_PER_BUILD: 1
    REGISTRY_DATABASE_ENABLED: "true"
    REGISTRY_DATABASE_HOST: "db"
    REGISTRY_DATABASE_PORT: "5432"
    REGISTRY_DATABASE_USER: "boryna"
    REGISTRY_DATABASE_PASSWORD: "Chleboslaw"
    REGISTRY_DATABASE_DBNAME: "registry_test"
    REGISTRY_DATABASE_SSLMODE: "disable"
    TAGS: 'integration'
  services:
    - name: registry.gitlab.com/gitlab-org/container-registry/postgresql-ci:${PG_VERSION}
      alias: "db"
      variables:
        POSTGRES_ROLE: primary
  script: $GO_TEST -v -timeout=25m -coverprofile=coverage.out -tags=$TAGS

api:online-gc:
  <<: *database
  variables:
    <<: *database-variables
    TAGS: 'integration,online_gc_test'
    PACKAGE: 'github.com/docker/distribution/registry/handlers'
  script: $GO_TEST -v -coverprofile=coverage.out -tags=$TAGS -run=OnlineGC

# NOTE(prozlach): This job verifies that the minimum postresql version that we
# check for during container-registry startup matches the minimum PostgreSQL
# version that we test against in the CI
database:verify-postgresql-min-version:
  stage: integration
  needs: []
  image: alpine:latest
  script:
    # Install bash if not available
    - apk add --no-cache bash

    # Run the verification script with bash
    - |
      #!/bin/bash
      set -euo pipefail

      # Extract PG_PREV_VERSION from .gitlab-ci.yml
      PG_PREV_VERSION=$(grep -E '^\s*PG_PREV_VERSION:' .gitlab-ci.yml | grep -oE '[0-9]+')
      echo "PG_PREV_VERSION from .gitlab-ci.yml: ${PG_PREV_VERSION}"

      # Extract MinPostgresqlVersion from datastore.go (assuming minor version is always 0)
      MIN_PG_VERSION=$(grep -E 'MinPostgresqlVersion.*=' registry/datastore/datastore.go | grep -oE '[0-9]+\.[0-9]+' | cut -d. -f1)
      echo "MinPostgresqlVersion from datastore.go: ${MIN_PG_VERSION}"

      # Compare versions
      if [ "${PG_PREV_VERSION}" != "${MIN_PG_VERSION}" ]; then
        echo "ERROR: PostgreSQL minimum version mismatch!"
        echo "PG_PREV_VERSION in .gitlab-ci.yml: ${PG_PREV_VERSION}"
        echo "MinPostgresqlVersion in datastore.go: ${MIN_PG_VERSION}"
        echo "These values must match to ensure consistency."
        exit 1
      else
        echo "SUCCESS: PostgreSQL minimum versions match (${PG_PREV_VERSION})"
      fi
  rules:
    # Run on changes to either file
    - changes:
        - .gitlab-ci.yml
        - registry/datastore/datastore.go

database:migrations:
  <<: *database
  variables:
    <<: *database-variables
    PACKAGE: 'github.com/docker/distribution/registry/datastore/migrations'

database:datastore:
  <<: *database
  variables:
    <<: *database-variables
    PACKAGE: 'github.com/docker/distribution/registry/datastore'

database:api:
  <<: *database
  variables:
    <<: *database-variables
    PACKAGE: 'github.com/docker/distribution/registry/handlers'
    TAGS: integration,handlers_test

database:api-conformance:
  <<: *database
  variables:
    <<: *database-variables
    PACKAGE: 'github.com/docker/distribution/registry/handlers'
    TAGS: 'integration,api_conformance_test'
  script: $GO_TEST -v -timeout=25m -tags=$TAGS

database:api-gitlab:
  <<: *database
  variables:
    <<: *database-variables
    PACKAGE: 'github.com/docker/distribution/registry/handlers'
    TAGS: 'integration,api_gitlab_test'
  script: $GO_TEST -v -timeout=25m -tags=$TAGS

# Tests that simulate adverse network conditions/errors between the registry and its database.
database:api-fault-tolerance:
  <<: *database
  variables:
    <<: *database-variables
    PACKAGE: 'github.com/docker/distribution/registry/handlers'
    TOXIPROXY_HOST: 'toxiproxy'
    TOXIPROXY_PORT: '8474'
    TAGS: 'integration,toxiproxy'
  services:
    # `services` are not extended, so we have to redeclare `postgres` here.
    - name: registry.gitlab.com/gitlab-org/container-registry/postgresql-ci:${PG_VERSION}
      alias: "db"
      variables:
        POSTGRES_ROLE: primary
    - name: shopify/toxiproxy
      alias: "toxiproxy"
  script: $GO_TEST -v -coverprofile=coverage.out -tags=$TAGS -run ^TestDBFaultTolerance

database:background-migrations:
  <<: *database
  variables:
    <<: *database-variables
    PACKAGE: 'github.com/docker/distribution/registry/bbm'
    TAGS: 'integration'
  script: $GO_TEST -v -coverprofile=coverage.out -tags=$TAGS

.database-load-balancing: &database-load-balancing
  <<: *database
  extends:
    - .go-test
  parallel:
    matrix:
      - PG_VERSION: $PG_PREV_VERSION
        GO_VERSION: [ "1.23", "1.24" ]
        KV_TYPE: [ redis, valkey ]
      - PG_VERSION: $PG_CURR_VERSION
        GO_VERSION: [ "1.23", "1.24" ]
        KV_TYPE: [ redis, valkey ]
      - PG_VERSION: $PG_NEXT_VERSION
        GO_VERSION: [ "1.23", "1.24" ]
        KV_TYPE: [ redis, valkey ]
  variables: &database-load-balancing-variables
    <<: *database-variables
    REGISTRY_DATABASE_HOST: "postgres-primary"
    REGISTRY_DATABASE_LOADBALANCING_ENABLED: "true"
    REGISTRY_REDIS_LOADBALANCING_ENABLED:  "true"
    REGISTRY_REDIS_LOADBALANCING_ADDR: "kv:6379"
    PACKAGE: "github.com/docker/distribution/registry/handlers"
    TAGS: "integration,handlers_test,api_gitlab_test,api_conformance_test"
  services:
    - name: registry.gitlab.com/gitlab-org/container-registry/kv-ci-${KV_TYPE}:bookworm
      alias: "kv"
      variables:
        KV_ROLE: primary
    - name: registry.gitlab.com/gitlab-org/container-registry/postgresql-ci:${PG_VERSION}
      alias: "postgres-primary"
      variables:
        POSTGRES_ROLE: primary
    - name: registry.gitlab.com/gitlab-org/container-registry/postgresql-ci:${PG_VERSION}
      alias: "postgres-replica1"
      variables:
        POSTGRES_ROLE: replica
        PRIMARY_HOST: postgres-primary
        REPLICATION_SLOT: 1
    - name: registry.gitlab.com/gitlab-org/container-registry/postgresql-ci:${PG_VERSION}
      alias: "postgres-replica2"
      variables:
        POSTGRES_ROLE: replica
        PRIMARY_HOST: postgres-primary
        REPLICATION_SLOT: 2
    # not needed for all scenarios but avoids having to declare all services in each as `services` can't be extended
    - name: registry.gitlab.com/gitlab-org/container-registry/test-dns-server:28d4a455
      alias: "test-dns-server"
      variables:
        DNS_SERVER_SRV_RECORD: "replica.registry-db.service.consul"
        DNS_SERVER_REPLY_HOSTS: "postgres-replica1,postgres-replica2"
        DNS_SERVER_REPLY_PORT: "5432"
        DNS_SERVER_LISTEN_PORT: "8600"
  script: $GO_TEST -v -timeout=35m -coverprofile=coverage.out -tags=$TAGS

database:api-load-balancing-hosts:
  <<: *database-load-balancing
  variables:
    <<: *database-load-balancing-variables
    REGISTRY_DATABASE_LOADBALANCING_HOSTS: "postgres-replica1,postgres-replica2"

database:api-load-balancing-discovery:
  <<: *database-load-balancing
  variables:
    <<: *database-load-balancing-variables
    REGISTRY_DATABASE_LOADBALANCING_RECORD: "replica.registry-db.service.consul"
    REGISTRY_DATABASE_LOADBALANCING_NAMESERVER: "test-dns-server"
    REGISTRY_DATABASE_LOADBALANCING_PORT: "8600"

.cache:kv: &cache-kv
  extends: .go-test
  parallel:
    matrix:
      - GO_VERSION: [ "1.23", "1.24" ]
        KV_TYPE: [ redis, valkey ]
  stage: integration
  variables: &cache-kv-variables
    PACKAGE: "github.com/docker/distribution/registry/storage/cache/redis"
  script: $GO_TEST -v -coverprofile=coverage.out -tags=integration

cache:kv:
  <<: *cache-kv
  variables:
    <<: *cache-kv-variables
    KV_ADDR: "kv-node1:6379"
  services:
    - name: registry.gitlab.com/gitlab-org/container-registry/kv-ci-${KV_TYPE}:bookworm
      alias: kv-node1
      variables:
        KV_ROLE: primary
        KV_ANNOUNCE_IP: kv-node1

cache:kv-auth:
  <<: *cache-kv
  variables:
    <<: *cache-kv-variables
    # create a Docker network per build so that services can talk with each other
    FF_NETWORK_PER_BUILD: 1
    KV_ADDR: "kv-node1:6379"
    KV_USERNAME: "my-kv-user"
    KV_PASSWORD: "my-kv-pass"
  services:
    - name: registry.gitlab.com/gitlab-org/container-registry/kv-ci-${KV_TYPE}:bookworm
      alias: kv-node1
      variables:
        KV_ROLE: primary
        KV_ANNOUNCE_IP: kv-node1

cache:kv-sentinel:
  <<: *cache-kv
  variables:
    <<: *cache-kv-variables
    # create a Docker network per build so that services can talk with each other
    FF_NETWORK_PER_BUILD: 1
    # config for app
    KV_ADDR: "kv-sentinel:6379"
    KV_MAIN_NAME: "fluffy"
  services:
    - name: registry.gitlab.com/gitlab-org/container-registry/kv-ci-${KV_TYPE}:bookworm
      alias: kv-node1
      variables:
        KV_ROLE: primary
        KV_ANNOUNCE_IP: kv-node1
    - name: registry.gitlab.com/gitlab-org/container-registry/kv-ci-${KV_TYPE}:bookworm
      alias: kv-node2
      variables:
        KV_ROLE: replica
        KV_ANNOUNCE_IP: kv-node2
        KV_PRIMARY_HOST: kv-node1
    - name: registry.gitlab.com/gitlab-org/container-registry/kv-ci-${KV_TYPE}:bookworm
      alias: kv-sentinel
      variables:
        KV_ROLE: sentinel
        KV_ANNOUNCE_IP: kv-sentinel
        KV_MONITOR_HOST: kv-node1

cache:kv-sentinel-auth:
  <<: *cache-kv
  variables:
    <<: *cache-kv-variables
    # create a Docker network per build so that services can talk with each other
    FF_NETWORK_PER_BUILD: 1
    # config for app
    KV_ADDR: "kv-sentinel:6379"
    KV_MAIN_NAME: "fluffy"
    KV_SENTINEL_USERNAME: "my-sentinel-user"
    KV_SENTINEL_PASSWORD: "my-sentinel-pass"
  services:
    - name: registry.gitlab.com/gitlab-org/container-registry/kv-ci-${KV_TYPE}:bookworm
      alias: kv-node1
      variables:
        KV_ROLE: primary
        KV_ANNOUNCE_IP: kv-node1
    - name: registry.gitlab.com/gitlab-org/container-registry/kv-ci-${KV_TYPE}:bookworm
      alias: kv-node2
      variables:
        KV_ROLE: replica
        KV_ANNOUNCE_IP: kv-node2
        KV_PRIMARY_HOST: kv-node1
    - name: registry.gitlab.com/gitlab-org/container-registry/kv-ci-${KV_TYPE}:bookworm
      alias: kv-sentinel
      variables:
        KV_ROLE: sentinel
        KV_ANNOUNCE_IP: kv-sentinel
        KV_MONITOR_HOST: kv-node1

base-driver:
  <<: *storage-driver-test
  variables:
    <<: *storage-driver-variables
    PACKAGE: "github.com/docker/distribution/registry/storage/driver/base"

kv:rate-limiter:handlers:
  <<: *cache-kv
  variables:
    <<: *cache-kv-variables
    KV_ADDR: "kv-node1:6379"
    PACKAGE: 'github.com/docker/distribution/registry/middleware/ratelimiter'
  services:
    - name: registry.gitlab.com/gitlab-org/container-registry/kv-ci-${KV_TYPE}:bookworm
      alias: kv-node1
      variables:
        KV_ROLE: primary
        KV_ANNOUNCE_IP: kv-node1
    - name: registry.gitlab.com/gitlab-org/container-registry/kv-ci-${KV_TYPE}:bookworm
      alias: kv-node2
      variables:
        KV_ROLE: replica
        KV_ANNOUNCE_IP: kv-node2
        KV_PRIMARY_HOST: kv-node1

.kv-cluster: &kv-cluster
  extends: .go-test
  parallel:
    matrix:
      - GO_VERSION: [ "1.23", "1.24" ]
        KV_TYPE: [ redis, valkey ]
  stage: integration
  variables: &kv-cluster-variables
    KV_ADDR: "kv-node1:6379,kv-node2:6379,kv-node3:6379"
  services:
    - name: registry.gitlab.com/gitlab-org/container-registry/kv-ci-${KV_TYPE}:bookworm
      alias: kv-node1
      variables:
        KV_ROLE: cluster-node
        KV_ANNOUNCE_IP: kv-node1
    - name: registry.gitlab.com/gitlab-org/container-registry/kv-ci-${KV_TYPE}:bookworm
      alias: kv-node2
      variables:
        KV_ROLE: cluster-node
        KV_ANNOUNCE_IP: kv-node2
    - name: registry.gitlab.com/gitlab-org/container-registry/kv-ci-${KV_TYPE}:bookworm
      alias: kv-node3
      variables:
        KV_ROLE: cluster-node
        KV_ANNOUNCE_IP: kv-node3
    - name: registry.gitlab.com/gitlab-org/container-registry/kv-ci-${KV_TYPE}:bookworm
      alias: kv-starter
      variables:
        KV_ROLE: cluster-starter
        KV_ANNOUNCE_IP: kv-starter
        KV_CLUSTER_NODES: kv-node1,kv-node2,kv-node3

kv-cluster:rate-limiter:handlers:
  <<: *kv-cluster
  variables:
    <<: *kv-cluster-variables
    PACKAGE: 'github.com/docker/distribution/registry/middleware/ratelimiter'
  script:
    - $GO_TEST -v -coverprofile=coverage.out -tags=integration

# cli:schema-migration-dependency is an integration test suite that verifies the dependency resolver for post/pre-deployment schema migrations.
cli:schema-migration-dependency:
  extends:
    - .go-test
  tags:
    - gitlab-org-docker
  services:
    - name: docker:${DOCKER_VERSION}-dind
      alias: docker
  stage: integration
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    TAGS: 'integration,cli_test'
    PACKAGE: 'github.com/docker/distribution/registry'
  script: $GO_TEST -v -coverprofile=coverage.out -tags=$TAGS
